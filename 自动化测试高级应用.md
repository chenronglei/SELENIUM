# 8.1 HTML测试报告
需要一份漂亮且通俗易懂的测试报告来展示自动化测试成果,一个简单的log文件是不够的.  
HTMLTestRunner是python标准库unittest单元测试框架的一个扩展，它生成易于使用的HTML报告  
## 8.1.1 修改HTMLTestRunner  
HTMLTestRunner.py是基于Python2开发的，为了使其支持python 3的环境，需要对其中的部分内容进行修改。  
## 8.1.2 生成HTMl测试报告  
> from selenium import webdriver  
import unittest  
from HTMLTestRunner import HTMLTestRunner  
class Baidu(unittest.TestCase):  
&nbsp;&nbsp;&nbsp;&nbsp;def setUp(self):  
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self.driver = webdriver.Firefox()  
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#self.driver.maximize_window()  
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self.driver.implicitly_wait(10)  
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self.base_url="http://www.baidu.com"  
&nbsp;&nbsp;&nbsp;def test_baidu_search(self):  
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;driver = self.driver  
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;driver.get(self.base_url)  
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;driver.find_element_by_id("kw").clear()  
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;driver.find_element_by_id("kw").send_keys("HTMLTestRunner")  
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;driver.find_element_by_id("su").click()  
&nbsp;&nbsp;&nbsp;def tearDown(self):  
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self.driver.quit()  
if __name__ == "__main__":  
&nbsp;&nbsp;&nbsp;testunit = unittest.TestSuite()  
&nbsp;&nbsp;&nbsp;testunit.addTest(Baidu("test_baidu_search"))  
&nbsp;&nbsp;&nbsp;#定义报告存放路径，以二进制文件打开文件  
&nbsp;&nbsp;&nbsp;fp = open('./result.html','wb')  
&nbsp;&nbsp;&nbsp;#定义测试报告  
&nbsp;&nbsp;&nbsp;runner = HTMLTestRunner(stream=fp,title='百度搜索测试报告',description='用例执行情况：')  
&nbsp;&nbsp;&nbsp;runner.run(testunit) #运行测试用例  
&nbsp;&nbsp;&nbsp;fp.close()  #关闭测试报告  
    
用例执行完成后，在同级目录下生成 result.html测试报告  
## 8.1.3 更易读的测试报告 
上面生成的测试报告还不易读，因为它只罗列了一堆测试类和测试方法，我们需要用心地为测试类和测试方法命名才能提高测试报告的可读性。  
Python的注释有两种，一种叫comment，另外一种叫doc string.前装为普通注释，后者用于函数、类和方法的描述  
在类或方法的下方，通过三引号来添加doc string 类型的注释，这类注释在平时的调用不显示，可以通过help()方法来查看类或方法的这种注释  
HTMLTestRunner可以读取doc string类型的注释，我们只需要给测试类或方法添加这种类型的注释即可  
> ......  
class Baidu(unittest.TestCase):  
&nbsp;&nbsp;&nbsp;&nbsp;'''百度搜索测试'''  
...  
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;def test_baidu_search(self):  
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;'''搜索关键字：HTMLTestRunner'''  

## 8.1.4 测试报告的文件名
每次运行测试之前，都需要手动修改测试报告的名称，如果忘记修改，就会把之前的报告覆盖。最好的方法是在报告中加入当前时间，这样生成的报告既不会重叠，又能清晰
地知道报告的时间  
>>> time.time()    #获取当前时间戳  
1519658104.089335  
>>> time.ctime()  #当前时间的字符串形式  
'Mon Feb 26 23:15:25 2018'  
>>> time.localtime()  #当前时间的struct_time形式  
time.struct_time(tm_year=2018, tm_mon=2, tm_mday=26, tm_hour=23, tm_min=15, tm_sec=35, tm_wday=0, tm_yday=57, tm_isdst=0)  
>>> time.strftime("%Y_%m_%d %H:%M_%S")  #获取当前时间，可以将时间格式化为字符串  
'2018_02_26 23:16_55'  

修改测试用例  
 
> #按照一定格式获取当前时间 
w = time.strftime("%Y-%m-%d %H_%M_%S")  
#定义报告存放路径，以二进制文件打开文件  
filename = './' + now + 'result.html'  
fp = open(filename,'wb')  

## 8.1.5 测试报告的文件名
目前的HTMLTestRunner只是针对单个测试文件生成测试报告，我们最终的目的是希望它集成到runtest.py文件中，使其作用于整个测试项目

> import unittest  
import time  
from HTMLTestRunner import HTMLTestRunner  
#定义测试用例为当前文件夹下的test_case目录  
test_dir='./test_case'  
discover = unittest.defaultTestLoader.discover(test_dir,pattern='test*.py')  
if __name__ == '__main__':  
&nbsp;&nbsp;&nbsp;&nbsp;now = time.strftime("%Y-%m-%d %H_%M_%S")  
&nbsp;&nbsp;&nbsp;&nbsp;filename = test_dir + '/' + now + 'result.html'  
&nbsp;&nbsp;&nbsp;&nbsp;fp = open(filename,'wb')  
&nbsp;&nbsp;&nbsp;&nbsp;runner = HTMLTestRunner(stream=fp,title='测试报告',description='用例执行情况')  
&nbsp;&nbsp;&nbsp;&nbsp;runner.run(discover)  
&nbsp;&nbsp;&nbsp;&nbsp;fp.close()  

# 8.2 自动发送邮件功能  
我们想要自动化脚本运行完成以后，邮件可以收到最新的测试报告结果 
## 8.2.1 发送HTML格式的邮件  
> import smtplib  
from email.mime.text import MIMEText  
from email.header import Header  
#发送邮箱服务器  
smtpserver = 'smtp.exmail.qq.com'  
#发送邮箱用户/密码  
user = 'chenronglei@minieye.cc'  
password = 'Root_123'  
#发送邮箱  
sender = 'chenronglei@minieye.cc'  
#接收邮箱  
receiver = 'chenhugua@163.com'  
#发送邮件主题  
subject = 'Python email test'  
#编写HTML类型的邮件正文  
msg = MIMEText('&lt;html>&lt;h1>你好！继续努力&lt;/h1>&lt;/html>','html','utf-8')  
msg['Subject'] = Header(subject,'utf-8')  
#连接发送邮件  
smtp = smtplib.SMTP()  
smtp.connect(smtpserver)  
smtp.login(user,password)  
smtp.sendmail(sender,receiver,msg.as_string())  
smtp.quit()  

上例中使用了STMP模块和email模块的Header()、MIMEText()方法。Header()方法用来定义邮件标题，MIMEText()用来定义邮件的正文，参数为html格式的文本





